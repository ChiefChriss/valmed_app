{% extends "base.html" %}
{% block content %}

<div class="row">
  <!-- Task Details (Left Column) -->
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h4 class="mb-1">{{ task.title }}</h4>
            <small class="text-muted">
              Created by {{ task.creator.username }} on {{ task.created_at.strftime('%B %d, %Y at %I:%M %p') if task.created_at }}
            </small>
          </div>
          <a href="{{ url_for('tasks') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Board
          </a>
        </div>
      </div>

      <div class="card-body">
        <h6 class="text-muted mb-2">Description</h6>
        <p class="mb-4">{{ task.description or 'No description provided.' }}</p>

        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <h6 class="text-muted mb-2">Status</h6>
            <span class="badge rounded-pill 
              {% if task.status and task.status.is_complete %}bg-success
              {% elif task.status and task.status.label == 'In-Progress' %}bg-warning text-dark
              {% else %}bg-secondary{% endif %} px-3 py-2">
              {{ task.status.label if task.status else 'None' }}
            </span>
          </div>

          <div class="col-md-6">
            <h6 class="text-muted mb-2">Assigned To</h6>
            {% if task.assignee %}
              <span class="badge rounded-pill bg-info text-white">
                <i class="bi bi-person-fill me-1"></i> {{ task.assignee.username }}
              </span>
            {% elif task.assigned_group %}
              <span class="badge rounded-pill bg-warning text-dark">
                <i class="bi bi-people-fill me-1"></i> {{ task.assigned_group.name }}
              </span>
            {% else %}
              <span class="text-muted fst-italic">Unassigned</span>
            {% endif %}
          </div>

          {% if task.due_date %}
          <div class="col-md-6">
            <h6 class="text-muted mb-2">Due Date</h6>
            <span class="badge rounded-pill bg-warning text-dark">
              <i class="bi bi-calendar-event me-1"></i>
              {{ task.due_date.strftime('%B %d, %Y') }}
            </span>
          </div>
          {% endif %}

          {% if task.completed_at %}
          <div class="col-md-6">
            <h6 class="text-muted mb-2">Completed At</h6>
            <span class="text-muted">{{ task.completed_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="card shadow-sm">
      <div class="card-header bg-white py-3 border-bottom">
        <h5 class="mb-0">
          <i class="bi bi-chat-left-text me-2"></i>
          Comments ({{ task.comments|length }})
        </h5>
      </div>

      <div class="card-body">
        <!-- Add Comment Form -->
        {% if can_comment %}
        <form method="POST" action="{{ url_for('add_task_comment', task_id=task.id) }}" class="mb-4">
          <div class="mb-3">
            <label class="form-label fw-bold">Add a comment</label>
            <textarea class="form-control" name="content" rows="3" 
                      placeholder="Share your thoughts, updates, or questions..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-send me-2"></i> Post Comment
          </button>
        </form>
        {% else %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          You don't have permission to comment on this task.
        </div>
        {% endif %}

        <!-- Comments List -->
        {% if task.comments %}
        <div class="comments-list">
          {% for comment in task.comments %}
          <div class="comment-item border-bottom pb-3 mb-3">
            <div class="d-flex align-items-start">
              <div class="avatar me-3 bg-primary rounded-circle d-flex align-items-center justify-content-center text-white"
                   style="width: 40px; height: 40px; min-width: 40px;">
                <span class="fw-bold">{{ comment.user.username[0].upper() }}</span>
              </div>

              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <strong>{{ comment.user.username }}</strong>
                    {% if comment.user.employee %}
                      <span class="text-muted small">({{ comment.user.employee.full_name() }})</span>
                    {% endif %}
                    <br>
                    <small class="text-muted">
                      {{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                      {% if comment.updated_at %}
                        <span class="badge bg-light text-dark border ms-1">Edited</span>
                      {% endif %}
                    </small>
                  </div>

                  <!-- Edit/Delete Buttons -->
                  {% if current_user.id == comment.user_id or current_user.is_admin() %}
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border-0" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <button class="dropdown-item" data-bs-toggle="modal" 
                                data-bs-target="#editCommentModal{{ comment.id }}">
                          <i class="bi bi-pencil me-2"></i> Edit
                        </button>
                      </li>
                      <li>
                        <form method="POST" action="{{ url_for('delete_task_comment', task_id=task.id, comment_id=comment.id) }}"
                              onsubmit="return confirm('Delete this comment?');">
                          <button class="dropdown-item text-danger">
                            <i class="bi bi-trash me-2"></i> Delete
                          </button>
                        </form>
                      </li>
                    </ul>
                  </div>
                  {% endif %}
                </div>

                <p class="mb-0" style="white-space: pre-wrap;">{{ comment.content }}</p>
              </div>
            </div>
          </div>

          <!-- Edit Comment Modal -->
          <div class="modal fade" id="editCommentModal{{ comment.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Edit Comment</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_task_comment', task_id=task.id, comment_id=comment.id) }}">
                  <div class="modal-body">
                    <textarea class="form-control" name="content" rows="4" required>{{ comment.content }}</textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4 text-muted">
          <i class="bi bi-chat-left display-6 opacity-25"></i>
          <p class="mt-2">No comments yet. Be the first to comment!</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Task Actions (Right Sidebar) -->
  <div class="col-lg-4">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0">Actions</h6>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('update_task_status', task_id=task.id) }}" class="mb-3">
          <label class="form-label small fw-bold">Change Status</label>
          <select name="status_id" class="form-select form-select-sm mb-2">
            {% for s in statuses %}
            <option value="{{ s.id }}" {% if task.status_id == s.id %}selected{% endif %}>
              {{ s.label }}
            </option>
            {% endfor %}
          </select>
          <button class="btn btn-sm btn-primary w-100">Update Status</button>
        </form>

        {% if current_user.is_admin() %}
        <hr>
        <button class="btn btn-sm btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteTaskModal">
          <i class="bi bi-trash me-2"></i> Delete Task
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Task Info Card -->
    <div class="card shadow-sm">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0">Details</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <small class="text-muted d-block">Task ID</small>
          <strong>#{{ task.id }}</strong>
        </div>
        <div class="mb-3">
          <small class="text-muted d-block">Created By</small>
          <strong>{{ task.creator.username }}</strong>
        </div>
        <div class="mb-3">
          <small class="text-muted d-block">Created</small>
          <span>{{ task.created_at.strftime('%b %d, %Y') if task.created_at }}</span>
        </div>
        {% if task.assigned_group %}
        <div class="mb-3">
          <small class="text-muted d-block">Group Members</small>
          <div class="d-flex flex-wrap gap-1 mt-1">
            {% for u in task.assigned_group.users %}
              <span class="badge rounded-pill bg-light text-dark border" style="font-size: 0.7rem;">
                {{ u.username }}
              </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Delete Task Modal -->
{% if current_user.is_admin() %}
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Delete Task</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Are you sure you want to delete this task?</p>
        <p class="text-muted small mt-2">This will also delete all {{ task.comments|length }} comment(s). This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete Task</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

