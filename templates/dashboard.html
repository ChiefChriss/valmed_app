{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2 mb-1">Dashboard</h1>
        {% if current_user %}
        <p class="text-muted mb-0">
            Welcome back, <strong>
            {% if current_user.employee %}
                {{ current_user.employee.first_name }}
            {% else %}
                {{ current_user.username }}
            {% endif %}
            </strong>
            {% if current_user.is_admin() %}
                <span class="badge rounded-pill bg-danger ms-2">
                    <i class="bi bi-shield-check"></i> Admin
                </span>
            {% endif %}
        </p>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
  <div class="col-md-4">
    <a href="{{ url_for('tasks') }}" class="text-decoration-none">
      <div class="card h-100 border-start border-primary border-4 stat-card">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
              <h6 class="card-subtitle mb-2 text-muted">Total Tasks</h6>
              <h2 class="card-title mb-0">{{ open_tasks }}</h2>
          </div>
          <div class="display-4 text-primary opacity-25"><i class="bi bi-list-check"></i></div>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-4">
    <a href="{{ url_for('employees') }}" class="text-decoration-none">
      <div class="card h-100 border-start border-success border-4 stat-card">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
              <h6 class="card-subtitle mb-2 text-muted">Employees</h6>
              <h2 class="card-title mb-0">{{ employees_count }}</h2>
          </div>
          <div class="display-4 text-success opacity-25"><i class="bi bi-people-fill"></i></div>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-4">
    <a href="{{ url_for('groups') }}" class="text-decoration-none">
      <div class="card h-100 border-start border-warning border-4 stat-card">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
              <h6 class="card-subtitle mb-2 text-muted">Groups</h6>
              <h2 class="card-title mb-0">{{ groups_count }}</h2>
          </div>
          <div class="display-4 text-warning opacity-25"><i class="bi bi-collection-fill"></i></div>
        </div>
      </div>
    </a>
  </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white py-3">
        <h5 class="card-title mb-0"><i class="bi bi-table me-2"></i>My Tasks</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="ps-3">Title</th>
                  <th scope="col">Status</th>
                  <th scope="col">Assigned Group</th>
                  <th scope="col">Created At</th>
                </tr>
              </thead>
              <tbody>
                {% for t in my_tasks %}
                <tr style="cursor: pointer;" onclick="window.location.href='{{ url_for('view_task', task_id=t.id) }}'">
                  <td class="ps-3 fw-medium">
                    {{ t.title }}
                    {% if t.comments|length > 0 %}
                      <span class="badge rounded-pill bg-light text-dark border ms-2" style="font-size: 0.7rem;">
                        <i class="bi bi-chat-left-text"></i> {{ t.comments|length }}
                      </span>
                    {% endif %}
                  </td>
                  <td>
                      <span class="badge rounded-pill 
                        {% if t.status and t.status.is_complete %}bg-success
                        {% elif t.status and t.status.label == 'In-Progress' %}bg-warning text-dark
                        {% else %}bg-secondary{% endif %}">
                        {{ t.status.label if t.status else 'None' }}
                      </span>
                  </td>
                  <td>
                      {% if t.assigned_group %}
                        <span class="badge rounded-pill bg-info text-white">{{ t.assigned_group.name }}</span>
                      {% else %}
                        <span class="text-muted fst-italic">--</span>
                      {% endif %}
                  </td>
                  <td class="text-muted small">{{ t.created_at.strftime('%Y-%m-%d') if t.created_at else '' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center py-4 text-muted">No tasks found assigned to you.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
